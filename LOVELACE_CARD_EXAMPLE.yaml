# ============================================
# LOVELACE KARTA - SamoobsluÅ¾nÃ¡ lednice
# ============================================
# ZkopÃ­rujte tuto kartu do vaÅ¡eho Lovelace dashboardu
# Karta zobrazuje konzumaci hosta a tlaÄÃ­tko pro odhlÃ¡Å¡enÃ­

type: vertical-stack
cards:
  # Karta s konzumacÃ­
  - type: markdown
    title: ğŸ§¾ VaÅ¡e Konzumace
    content: |-
      {% set logged_in = is_state('input_boolean.lednice_guest_logged_in', 'on') %}
      {% set data = states('input_text.lednice_last_pin_result') %}

      {% if not logged_in %}
        ## ğŸ” Zadejte PIN
        Pro zobrazenÃ­ konzumace zadejte vÃ¡Å¡ PIN kÃ³d na klÃ¡vesnici.
      {% elif data and data != 'unknown' and data != '' %}
        {% set json = data | from_json %}
        {% if json.valid %}
          ## ğŸ‘¤ {{ json.guest_name or 'Host' }}
          **ğŸšª Pokoj:** {{ json.room.replace('room', '') }}

          {% if json.checkin %}
          **ğŸ“… ObdobÃ­:** {{ json.checkin[:10] }} - {{ json.checkout[:10] }}
          {% endif %}

          ---

          ### ğŸ›’ KonzumovanÃ© poloÅ¾ky:

          {% if json.item_summary %}
            | PoloÅ¾ka | MnoÅ¾stvÃ­ | Celkem |
            |---------|----------|--------|
            {% for item, details in json.item_summary.items() %}
            | {{ item }} | {{ details.quantity }}x | {{ details.total_price | round(0) }} KÄ |
            {% endfor %}
          {% else %}
          *ZatÃ­m Å¾Ã¡dnÃ¡ konzumace* âœ…
          {% endif %}

          ---

          ## ğŸ’° Celkem k ÃºhradÄ›: **{{ json.total_price | round(0) }} KÄ**

          *Celkem poloÅ¾ek: {{ json.total_items }}*

        {% else %}
          ## âŒ NeplatnÃ½ PIN
          Zadejte sprÃ¡vnÃ½ PIN pro zobrazenÃ­ konzumace.
        {% endif %}
      {% else %}
        ## â³ NaÄÃ­tÃ¡nÃ­...
        ÄŒekÃ¡nÃ­ na data po pÅ™ihlÃ¡Å¡enÃ­.
      {% endif %}

  # TlaÄÃ­tko pro odhlÃ¡Å¡enÃ­
  - type: entity-button
    entity: input_boolean.lednice_guest_logged_in
    name: ğŸšª OdhlÃ¡sit se
    icon: mdi:logout
    tap_action:
      action: toggle
    show_state: false
    show_icon: true

  # VolitelnÃ¡ debug karta - odkomentujte pro ladÄ›nÃ­
  # - type: entities
  #   title: ğŸ” Debug Info
  #   entities:
  #     - entity: input_boolean.lednice_guest_logged_in
  #       name: "Stav pÅ™ihlÃ¡Å¡enÃ­"
  #     - entity: input_text.lednice_current_pin
  #       name: "AktuÃ¡lnÃ­ PIN"
  #     - entity: input_text.lednice_last_pin_result
  #       name: "VÃ½sledek ovÄ›Å™enÃ­"

# ============================================
# ALTERNATIVNÃ VERZE - JednoduÅ¡Å¡Ã­ karta bez tabulky
# ============================================

# type: vertical-stack
# cards:
#   - type: markdown
#     title: ğŸ§¾ VaÅ¡e Konzumace
#     content: |-
#       {% set logged_in = is_state('input_boolean.lednice_guest_logged_in', 'on') %}
#       {% set data = states('input_text.lednice_last_pin_result') %}
#
#       {% if not logged_in %}
#         ## ğŸ” Zadejte PIN
#         Pro zobrazenÃ­ konzumace zadejte vÃ¡Å¡ PIN kÃ³d.
#       {% elif data and data != '' %}
#         {% set json = data | from_json %}
#         {% if json.valid %}
#           ## ğŸ‘¤ {{ json.guest_name }}
#           **ğŸšª Pokoj {{ json.room.replace('room', '') }}**
#
#           {% if json.checkin %}ğŸ“… {{ json.checkin[:10] }} - {{ json.checkout[:10] }}{% endif %}
#
#           ---
#
#           {% if json.item_summary %}
#             {% for item, details in json.item_summary.items() %}
#           â€¢ **{{ item }}**: {{ details.quantity }}x po {{ details.unit_price }} KÄ = **{{ details.total_price | round(0) }} KÄ**
#             {% endfor %}
#           {% else %}
#           *ZatÃ­m Å¾Ã¡dnÃ¡ konzumace* âœ…
#           {% endif %}
#
#           ---
#
#           ## ğŸ’° Celkem: **{{ json.total_price | round(0) }} KÄ**
#         {% else %}
#           âŒ **NeplatnÃ½ PIN**
#         {% endif %}
#       {% endif %}
#
#   - type: button
#     name: OdhlÃ¡sit se
#     icon: mdi:logout
#     tap_action:
#       action: call-service
#       service: input_boolean.turn_off
#       service_data:
#         entity_id: input_boolean.lednice_guest_logged_in
