# P≈ô√≠klady automatizac√≠ pro Lednice

# 1. Notifikace p≈ôi √∫spƒõ≈°n√©m skenov√°n√≠
- alias: "Lednice - Notifikace p≈ôi skenov√°n√≠"
  description: "Po≈°le notifikaci p≈ôi √∫spƒõ≈°n√©m nebo ne√∫spƒõ≈°n√©m skenov√°n√≠"
  trigger:
    - platform: event
      event_type: lednice_item_scanned
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.success }}"
          sequence:
            - service: notify.mobile_app
              data:
                title: "Lednice"
                message: >
                  ‚úÖ {{ trigger.event.data.item }} odebr√°n
                  {% if trigger.event.data.room %}
                  Pokoj: {{ trigger.event.data.room }}
                  {% endif %}
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.reason == 'out_of_stock' }}"
          sequence:
            - service: notify.mobile_app
              data:
                title: "Lednice - Vyprod√°no"
                message: "‚ùå {{ trigger.event.data.item }} nen√≠ na skladƒõ!"
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.reason == 'unknown_code' }}"
          sequence:
            - service: notify.mobile_app
              data:
                title: "Lednice - Nezn√°m√Ω k√≥d"
                message: "‚ö†Ô∏è Naskenov√°n nezn√°m√Ω k√≥d: {{ trigger.event.data.code }}"

# 2. Upozornƒõn√≠ na n√≠zk√Ω stav z√°sob
- alias: "Lednice - Upozornƒõn√≠ na n√≠zk√Ω stav"
  description: "Upozorn√≠ kdy≈æ nƒõkter√° polo≈æka m√° m√©nƒõ ne≈æ 3 kusy"
  trigger:
    - platform: state
      entity_id: sensor.lednice_inventory
  condition:
    - condition: template
      value_template: >
        {% set low_items = state_attr('sensor.lednice_inventory', 'items_detail')
           | selectattr('quantity', 'le', 2) | list %}
        {{ low_items | length > 0 }}
  action:
    - service: notify.mobile_app
      data:
        title: "Lednice - N√≠zk√Ω stav z√°sob"
        message: >
          N√°sleduj√≠c√≠ polo≈æky maj√≠ n√≠zk√Ω stav:
          {% set low_items = state_attr('sensor.lednice_inventory', 'items_detail')
             | selectattr('quantity', 'le', 2) | list %}
          {% for item in low_items %}
          - {{ item.name }}: {{ item.quantity }} ks
          {% endfor %}

# 3. Denn√≠ report spot≈ôeby
- alias: "Lednice - Denn√≠ report"
  description: "Po≈°le denn√≠ p≈ôehled spot≈ôeby v 20:00"
  trigger:
    - platform: time
      at: "20:00:00"
  action:
    - service: notify.mobile_app
      data:
        title: "Lednice - Denn√≠ report"
        message: >
          üìä Dne≈°n√≠ spot≈ôeba:
          {% set room_stats = state_attr('sensor.lednice_consumption', 'room_statistics') %}
          {% for room, count in room_stats.items() %}
          {{ room }}: {{ count }} ks
          {% endfor %}

          Celkem polo≈æek v invent√°≈ôi: {{ states('sensor.lednice_inventory') }}

# 4. Automatick√© doplnƒõn√≠ p≈ôi skenov√°n√≠ nezn√°m√©ho k√≥du
- alias: "Lednice - P≈ôid√°n√≠ nov√© polo≈æky"
  description: "Umo≈æn√≠ p≈ôidat novou polo≈æku po skenov√°n√≠ nezn√°m√©ho k√≥du"
  trigger:
    - platform: event
      event_type: lednice_item_scanned
      event_data:
        success: false
        reason: unknown_code
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.lednice_last_unknown_code
      data:
        value: "{{ trigger.event.data.code }}"
    - service: notify.mobile_app
      data:
        title: "Lednice - Nov√° polo≈æka?"
        message: "P≈ôejdƒõte do aplikace pro p≈ôid√°n√≠ polo≈æky s k√≥dem {{ trigger.event.data.code }}"
        data:
          actions:
            - action: "LEDNICE_ADD_ITEM"
              title: "P≈ôidat polo≈æku"

# 5. T√Ωdenn√≠ reset statistik (voliteln√©)
- alias: "Lednice - T√Ωdenn√≠ archivace"
  description: "Ka≈ædou nedƒõli v p≈Ølnoci archivuje statistiky"
  trigger:
    - platform: time
      at: "00:00:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: notify.mobile_app
      data:
        title: "Lednice - T√Ωdenn√≠ report"
        message: >
          üìà T√Ωdenn√≠ statistiky:
          Celkov√° spot≈ôeba: {{ state_attr('sensor.lednice_consumption', 'total_consumed') }}

          Top pokoje:
          {% set room_stats = state_attr('sensor.lednice_consumption', 'room_statistics') %}
          {% for room, count in (room_stats.items() | sort(attribute=1, reverse=true))[:3] %}
          {{ loop.index }}. {{ room }}: {{ count }} ks
          {% endfor %}

# 6. Kontrola invent√°≈ôe ka≈ædou hodinu
- alias: "Lednice - Hodinov√° kontrola"
  description: "Kontroluje stav invent√°≈ôe ka≈ædou hodinu"
  trigger:
    - platform: time_pattern
      hours: "*"
  condition:
    - condition: template
      value_template: >
        {% set items = state_attr('sensor.lednice_inventory', 'items_detail') | length %}
        {{ items == 0 }}
  action:
    - service: notify.mobile_app
      data:
        title: "Lednice - Pr√°zdn√Ω invent√°≈ô"
        message: "‚ö†Ô∏è Invent√°≈ô lednice je pr√°zdn√Ω!"

# 7. Notifikace pro konkr√©tn√≠ pokoj
- alias: "Lednice - Room1 spot≈ôeba"
  description: "Upozorn√≠ kdy≈æ room1 odebere v√≠ce ne≈æ 10 polo≈æek za den"
  trigger:
    - platform: state
      entity_id: sensor.lednice_room1_consumption
  condition:
    - condition: template
      value_template: "{{ states('sensor.lednice_room1_consumption') | int > 10 }}"
  action:
    - service: notify.mobile_app
      data:
        title: "Lednice - Vysok√° spot≈ôeba Room1"
        message: "Room1 odebral {{ states('sensor.lednice_room1_consumption') }} polo≈æek dnes"
