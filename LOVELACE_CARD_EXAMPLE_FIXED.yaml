# ============================================
# LOVELACE KARTA - Samoobslu≈æn√° lednice (OPRAVEN√Å VERZE)
# ============================================
# Tato verze obsahuje opravy pro stabiln√≠ zobrazen√≠

type: vertical-stack
cards:
  - type: markdown
    title: üßæ Va≈°e Konzumace
    content: >-
      {% set logged_in = is_state('input_boolean.lednice_guest_logged_in', 'on') %}
      {% set data = states('input_text.lednice_last_pin_result') %}

      {% if not logged_in %}
        ## üîê Zadejte PIN
        Pro zobrazen√≠ konzumace zadejte v√°≈° PIN k√≥d pomoc√≠ tlaƒç√≠tka n√≠≈æe.
      {% elif data and data not in ['unknown', 'unavailable', ''] %}
        {# Safe JSON parsing with error handling #}
        {% set json = namespace(data=none) %}
        {% set json.data = data | from_json if data is string else none %}

        {% if json.data and json.data.valid %}
          ## üë§ {{ json.data.guest_name | default('Host', true) }}
          **üö™ Pokoj:** {{ json.data.room | replace('room', '') | default('N/A', true) }}

          {% if json.data.checkin %}
          **üìÖ Obdob√≠:** {{ json.data.checkin[:10] }} - {{ json.data.checkout[:10] }}
          {% endif %}

          ---

          ### üõí Konzumovan√© polo≈æky:

          {% if json.data.item_summary and json.data.item_summary is mapping and json.data.item_summary | length > 0 %}
            | Polo≈æka | Mno≈æstv√≠ | Cena/ks | Celkem |
            |---------|----------|---------|--------|
            {% for item, details in json.data.item_summary.items() %}
            | {{ item }} | {{ details.quantity }}x | {{ details.unit_price | default(0) }} Kƒç | **{{ details.total_price | round(0) }} Kƒç** |
            {% endfor %}
          {% else %}
          *Zat√≠m ≈æ√°dn√° konzumace* ‚úÖ
          {% endif %}

          ---

          ## üí∞ Celkem k √∫hradƒõ: **{{ json.data.total_price | round(0) }} Kƒç**

          *Celkem polo≈æek: {{ json.data.total_items | default(0) }}*

          ---

          {# Safe countdown timer calculation #}
          {% set timer_entity = states.input_boolean.lednice_guest_logged_in %}
          {% if timer_entity and timer_entity.last_changed %}
            {% set elapsed = (now().timestamp() - timer_entity.last_changed.timestamp()) | int %}
            {% set remaining = (300 - elapsed) %}
            {% if remaining > 0 %}
          *Automatick√© odhl√°≈°en√≠ za {{ (remaining // 60) }} minut*
            {% else %}
          *Relace vypr≈°ela - p≈ôihlaste se znovu*
            {% endif %}
          {% endif %}

        {% else %}
          ## ‚ùå Neplatn√Ω PIN
          Zadejte spr√°vn√Ω PIN pro zobrazen√≠ konzumace.
        {% endif %}
      {% else %}
        ## ‚è≥ P≈ôipraveno
        ƒåek√°n√≠ na p≈ôihl√°≈°en√≠. Zadejte PIN pro zobrazen√≠ konzumace.
      {% endif %}

  # Tlaƒç√≠tko pro odhl√°≈°en√≠
  - type: entity-button
    entity: input_boolean.lednice_guest_logged_in
    name: üö™ Odhl√°sit se
    icon: mdi:logout
    tap_action:
      action: toggle
    show_state: false
    show_icon: true
