# ============================================
# KARTA PRO ZOBRAZENÃ KONZUMACE HOSTA
# ============================================
# Tato karta zobrazuje zakoupenÃ© vÄ›ci po pÅ™ihlÃ¡Å¡enÃ­ PINem
# Data se automaticky vymaÅ¾ou pÅ™i odhlÃ¡Å¡enÃ­

type: vertical-stack
cards:
  # HlavnÃ­ karta s konzumacÃ­
  - type: markdown
    title: ğŸ§¾ VaÅ¡e Konzumace
    content: >-
      {% set logged_in = is_state('input_boolean.lednice_guest_logged_in', 'on') %}
      {% set data_raw = states('input_text.lednice_last_pin_result') %}

      {% if logged_in and data_raw and data_raw not in ['unknown', 'unavailable', '', 'null'] %}
        {# BezpeÄnÃ© parsovÃ¡nÃ­ JSON - kontrola jestli je to validnÃ­ JSON string #}
        {% if data_raw[0:1] == '{' and data_raw[-1:] == '}' %}
          {% set data = data_raw | from_json %}

        {% if data and data.valid == true %}
          ## ğŸ‘¤ {{ data.guest_name | default('VÃ¡Å¾enÃ½ hoste', true) }}

          **ğŸšª Pokoj:** {{ data.room | replace('room', '') | replace('Room', '') | default('N/A', true) }}

          {% if data.checkin and data.checkout %}
          **ğŸ“… Pobyt:** {{ data.checkin[:10] }} - {{ data.checkout[:10] }}
          {% endif %}

          ---

          ### ğŸ›’ ZakoupenÃ© poloÅ¾ky:

          {% if data.item_summary and data.item_summary is mapping and data.item_summary | length > 0 %}
            | PoloÅ¾ka | MnoÅ¾stvÃ­ | Cena/ks | Celkem |
            |---------|----------|---------|--------|
            {% for item_name, item_data in data.item_summary.items() %}
            | {{ item_name }} | {{ item_data.quantity }}x | {{ item_data.unit_price | round(0) }} KÄ | **{{ item_data.total_price | round(0) }} KÄ** |
            {% endfor %}
          {% else %}
            *ZatÃ­m jste nic nekoupili* âœ…
          {% endif %}

          ---

          ## ğŸ’° Celkem k ÃºhradÄ›: **{{ data.total_price | default(0) | round(0) }} KÄ**

          *Celkem poloÅ¾ek: {{ data.total_items | default(0) }}*

          ---

          {# ÄŒasovaÄ automatickÃ©ho odhlÃ¡Å¡enÃ­ #}
          {% set timer = states.input_boolean.lednice_guest_logged_in %}
          {% if timer and timer.last_changed %}
            {% set elapsed = (now().timestamp() - timer.last_changed.timestamp()) | int %}
            {% set remaining_seconds = 300 - elapsed %}
            {% if remaining_seconds > 0 %}
              {% set minutes = (remaining_seconds // 60) %}
              {% set seconds = (remaining_seconds % 60) %}
          *AutomatickÃ© odhlÃ¡Å¡enÃ­ za {{ minutes }}:{{ '%02d' | format(seconds) }}*
            {% else %}
          *âš ï¸ Relace vyprÅ¡ela - pÅ™ihlaste se prosÃ­m znovu*
            {% endif %}
          {% endif %}

        {% else %}
          ## âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat
          Zkuste se prosÃ­m odhlÃ¡sit a pÅ™ihlÃ¡sit znovu.
        {% endif %}
        {% endif %}

      {% elif logged_in %}
        ## â³ NaÄÃ­tÃ¡nÃ­...
        ÄŒekÃ¡m na data z backendu.

      {% else %}
        ## ğŸ” Nejste pÅ™ihlÃ¡Å¡en(a)

        Pro zobrazenÃ­ vaÅ¡Ã­ konzumace se prosÃ­m pÅ™ihlaste pomocÃ­ **PINu vaÅ¡eho pokoje**.

        ### Jak se pÅ™ihlÃ¡sit:
        1. ğŸ”¢ Zadejte PIN na klÃ¡vesnici nÃ­Å¾e
        2. âœ… SystÃ©m zobrazÃ­ vaÅ¡e zakoupenÃ© poloÅ¾ky
        3. ğŸ’° UvidÃ­te celkovou ÄÃ¡stku k ÃºhradÄ›

        ---

        *PIN najdete na kartÄ› ve vaÅ¡em pokoji*
      {% endif %}

  # TlaÄÃ­tko pro odhlÃ¡Å¡enÃ­ - zobrazÃ­ se pouze kdyÅ¾ je nÄ›kdo pÅ™ihlÃ¡Å¡en
  - type: conditional
    conditions:
      - entity: input_boolean.lednice_guest_logged_in
        state: "on"
    card:
      type: entity-button
      entity: input_boolean.lednice_guest_logged_in
      name: ğŸšª OdhlÃ¡sit se
      icon: mdi:logout
      tap_action:
        action: toggle
      show_state: false
      show_icon: true
      hold_action:
        action: none

# ============================================
# POZNÃMKY K POUÅ½ITÃ
# ============================================
#
# 1. UjistÄ›te se, Å¾e mÃ¡te v configuration.yaml:
#    homeassistant:
#      packages: !include_dir_named packages
#
# 2. Soubor zamek2.yaml uloÅ¾te do /config/packages/zamek2.yaml
#
# 3. Restartujte Home Assistant
#
# 4. PÅ™idejte tuto kartu do vaÅ¡eho dashboardu
#
# 5. Pro testovÃ¡nÃ­:
#    - PÅ™ihlaste se pomocÃ­ PINu v lednice-selfservice-card.js
#    - MÄ›li byste vidÄ›t svÃ© zakoupenÃ© poloÅ¾ky
#    - Po odhlÃ¡Å¡enÃ­ by se mÄ›la karta vyprÃ¡zdnit
