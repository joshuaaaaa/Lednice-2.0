type: vertical-stack
cards:
  - type: markdown
    title: ğŸ§¾ VaÅ¡e Konzumace
    content: >-
      {% set logged_in = is_state('input_boolean.lednice_guest_logged_in', 'on') %}
      {% set current_room = states('input_text.lednice_current_room') %}

      {% if logged_in and current_room and current_room not in ['unknown', 'unavailable', '', 'null'] %}
        {# Get consumption log from sensor.lednice_inventory attributes #}
        {% set consumption_log = state_attr('sensor.lednice_inventory', 'consumption_log') | default([]) %}

        {# Get Previo pins for guest info #}
        {% set previo_pins = state_attr('sensor.lednice_inventory', 'previo_pins') | default({}) %}

        {# Find guest info for current room #}
        {% set guest_name = namespace(value='VÃ¡Å¾enÃ½ hoste') %}
        {% set checkin = namespace(value='') %}
        {% set checkout = namespace(value='') %}
        {% for key, pin_data in previo_pins.items() %}
          {% if pin_data.room == current_room %}
            {% set guest_name.value = pin_data.guest | default('VÃ¡Å¾enÃ½ hoste') %}
            {% set checkin.value = pin_data.checkin | default('') %}
            {% set checkout.value = pin_data.checkout | default('') %}
          {% endif %}
        {% endfor %}

        ## ğŸ‘¤ {{ guest_name.value }}

        **ğŸšª Pokoj:** {{ current_room | replace('room', '') | replace('Room', '') }}

        {% if checkin.value and checkout.value %}
        **ğŸ“… Pobyt:** {{ checkin.value[:10] if checkin.value is string else checkin.value }} - {{ checkout.value[:10] if checkout.value is string else checkout.value }}
        {% endif %}

        ---

        ### ğŸ›’ ZakoupenÃ© poloÅ¾ky:

        {# Filter logs for current room #}
        {% set room_logs = consumption_log | selectattr('room', 'eq', current_room) | list %}

        {# Group by item name #}
        {% set items = namespace(summary={}) %}
        {% for log in room_logs %}
          {% set item_name = log.item | default('Unknown') %}
          {% set qty = log.quantity | default(1) %}
          {% set price = log.price | default(0) %}

          {% if item_name in items.summary %}
            {% set _ = items.summary[item_name].update({'quantity': items.summary[item_name].quantity + qty}) %}
            {% set _ = items.summary[item_name].update({'total': items.summary[item_name].total + (price * qty)}) %}
          {% else %}
            {% set _ = items.summary.update({item_name: {'quantity': qty, 'price': price, 'total': price * qty}}) %}
          {% endif %}
        {% endfor %}

        {% if items.summary | length > 0 %}
          | PoloÅ¾ka | MnoÅ¾stvÃ­ | Cena/ks | Celkem |
          |---------|----------|---------|--------|
          {% for item_name, item_data in items.summary.items() %}
          | {{ item_name }} | {{ item_data.quantity }}x | {{ item_data.price | round(0) }} KÄ | **{{ item_data.total | round(0) }} KÄ** |
          {% endfor %}
        {% else %}
          *ZatÃ­m jste nic nekoupili* âœ…
        {% endif %}

        ---

        {# Calculate total #}
        {% set total = namespace(price=0, items=0) %}
        {% for log in room_logs %}
          {% set total.price = total.price + (log.price | default(0) * log.quantity | default(1)) %}
          {% set total.items = total.items + log.quantity | default(1) %}
        {% endfor %}

        ## ğŸ’° Celkem k ÃºhradÄ›: **{{ total.price | round(0) }} KÄ**

        *Celkem poloÅ¾ek: {{ total.items }}*

        ---

        {# ÄŒasovaÄ automatickÃ©ho odhlÃ¡Å¡enÃ­ #}
        {% set timer = states.input_boolean.lednice_guest_logged_in %}
        {% if timer and timer.last_changed %}
          {% set elapsed = (now().timestamp() - timer.last_changed.timestamp()) | int %}
          {% set remaining_seconds = 300 - elapsed %}
          {% if remaining_seconds > 0 %}
            {% set minutes = (remaining_seconds // 60) %}
            {% set seconds = (remaining_seconds % 60) %}
        *AutomatickÃ© odhlÃ¡Å¡enÃ­ za {{ minutes }}:{{ '%02d' | format(seconds) }}*
          {% else %}
        *âš ï¸ Relace vyprÅ¡ela - pÅ™ihlaste se prosÃ­m znovu*
          {% endif %}
        {% endif %}

      {% elif logged_in %}
        ## â³ NaÄÃ­tÃ¡nÃ­...
        ÄŒekÃ¡m na data z backendu.

      {% else %}
        ## ğŸ” Nejste pÅ™ihlÃ¡Å¡en(a)

        Pro zobrazenÃ­ vaÅ¡Ã­ konzumace se prosÃ­m pÅ™ihlaste pomocÃ­ **PINu vaÅ¡eho pokoje**.

        ### Jak se pÅ™ihlÃ¡sit:
        1. ğŸ”¢ Zadejte PIN na klÃ¡vesnici nÃ­Å¾e
        2. âœ… SystÃ©m zobrazÃ­ vaÅ¡e zakoupenÃ© poloÅ¾ky
        3. ğŸ’° UvidÃ­te celkovou ÄÃ¡stku k ÃºhradÄ›

        ---

        *DÄ›kujeme za nÃ¡kup a pÅ™ejeme krÃ¡snÃ½ den*
      {% endif %}

  # TlaÄÃ­tko pro odhlÃ¡Å¡enÃ­ - zobrazÃ­ se pouze kdyÅ¾ je nÄ›kdo pÅ™ihlÃ¡Å¡en
  - type: conditional
    conditions:
      - entity: input_boolean.lednice_guest_logged_in
        state: "on"
    card:
      type: entity-button
      entity: input_boolean.lednice_guest_logged_in
      name: ğŸšª OdhlÃ¡sit se
      icon: mdi:logout
      tap_action:
        action: toggle
      show_state: false
      show_icon: true
      hold_action:
        action: none
